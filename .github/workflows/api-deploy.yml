name: Deploy Backend API

on:
  push:
    branches: [ main ]
    paths:
      - 'money-flow/api/**'
      - '.github/workflows/api-deploy.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even without changes'
        required: false
        default: 'false'

env:
  PROJECT_ID: 'money-flow-469011'
  REGION: 'europe-west1'
  GAR_LOCATION: 'europe-west1'
  CLOUDBUILD_TRIGGER_NAME: 'georgian-budget-backend-trigger'

jobs:
  deploy-api:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

    - name: Trigger Cloud Build for Backend API
      run: |
        echo "ðŸ”¨ Triggering Cloud Build for Backend API deployment..."
        
        # Trigger the Cloud Build via the configured trigger
        gcloud builds triggers run ${{ env.CLOUDBUILD_TRIGGER_NAME }} \
          --region=${{ env.REGION }} \
          --branch=main
        
        echo "âœ… Cloud Build trigger initiated successfully"

    - name: Wait for deployment and verify
      run: |
        echo "â³ Waiting for Cloud Build to complete..."
        sleep 60
        
        # Check if the Cloud Run service is running
        echo "ðŸ” Checking Cloud Run service status..."
        gcloud run services describe georgian-budget-backend-api \
          --region=${{ env.REGION }} \
          --format="value(status.conditions[0].status)" > /tmp/status.txt
        
        if grep -q "True" /tmp/status.txt; then
          echo "âœ… Backend API deployment successful"
          
          # Get the service URL
          SERVICE_URL=$(gcloud run services describe georgian-budget-backend-api \
            --region=${{ env.REGION }} \
            --format="value(status.url)")
          echo "ðŸŒ Backend API URL: $SERVICE_URL"
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
        else
          echo "âŒ Backend API deployment failed or still in progress"
          echo "ðŸ“‹ Service status:"
          gcloud run services describe georgian-budget-backend-api \
            --region=${{ env.REGION }} \
            --format="table(status.conditions[].type,status.conditions[].status,status.conditions[].reason)"
          exit 1
        fi

    - name: Health check
      run: |
        if [ -n "$SERVICE_URL" ]; then
          echo "ðŸ¥ Performing health check..."
          
          # Wait a bit more for the service to be fully ready
          sleep 30
          
          # Try to hit the health endpoint
          if curl -f -s "$SERVICE_URL/health" > /dev/null 2>&1; then
            echo "âœ… Backend API health check passed"
          else
            echo "âš ï¸ Backend API health check failed (service may still be starting)"
            echo "ðŸ” Checking logs..."
            gcloud logs read "resource.type=cloud_run_revision AND resource.labels.service_name=georgian-budget-backend-api" \
              --limit=20 \
              --format="table(timestamp,severity,textPayload)" || true
          fi
        fi

    - name: Summary
      if: always()
      run: |
        echo "## ðŸ‡¬ðŸ‡ª Backend API Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Project**: ${{ env.PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Service**: georgian-budget-backend-api" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "$SERVICE_URL" ]; then
          echo "- **URL**: $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- **Triggered**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ env.CLOUDBUILD_TRIGGER_NAME }}" >> $GITHUB_STEP_SUMMARY
